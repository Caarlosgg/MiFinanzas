<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Dashboard | MiFinanzas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
  <div class="container-fluid">
    <a class="navbar-brand" href="/dashboard">MiFinanzas</a>
    <div>
      <a class="btn btn-outline-light me-2" href="/movimientos">Movimientos</a>
      <a class="btn btn-outline-light me-2" href="/presupuestos">Presupuestos</a>
      <a class="btn btn-outline-light me-2" href="/metas">Metas</a>
      <a class="btn btn-outline-light me-2" href="/usuarios/perfil">Perfil</a>
      <a class="btn btn-outline-light" th:href="@{/logout}">Cerrar sesiÃ³n</a>
    </div>
  </div>
</nav>

<div class="container">

  <!-- SALDO -->
  <div class="text-center mb-4">
    <h4 class="text-secondary">ğŸ’¼ Dinero disponible</h4>
    <h1 th:text="${#numbers.formatDecimal(balanceTotal,1,'COMMA',2,'POINT')} + ' â‚¬'"
        th:classappend="${balanceTotal >= 0} ? 'text-success' : 'text-danger'">
      0,00 â‚¬
    </h1>
    <a href="/movimientos/nuevo" class="btn btn-primary mt-2">
      â• AÃ±adir nuevo movimiento
    </a>
  </div>

  <div class="row mb-4">
    <!-- PRESUPUESTOS -->
    <div class="col-md-6">
      <div class="card border-secondary">
        <div class="card-header bg-secondary text-white">ğŸ’° Presupuestos</div>
        <div class="card-body">
          <p><strong>Total:</strong>
            <span th:text="${totalPresupuestos}">0</span>
          </p>
          <p class="text-success"><strong>âœ… Dentro:</strong>
            <span th:text="${presupuestosDentro}">0</span>
          </p>
          <p class="text-danger"><strong>âŒ Superados:</strong>
            <span th:text="${presupuestosSuperados}">0</span>
          </p>
        </div>
      </div>
    </div>
    <!-- METAS -->
    <div class="col-md-6">
      <div class="card border-primary">
        <div class="card-header bg-primary text-white">ğŸ¯ Metas</div>
        <div class="card-body" th:if="${#lists.isEmpty(metas)}">
          <p class="text-muted text-center">No tienes metas aÃºn.</p>
        </div>
        <ul class="list-group list-group-flush"
            th:if="${!#lists.isEmpty(metas)}">
          <li class="list-group-item d-flex justify-content-between"
              th:each="m : ${metas}">
            <span th:text="${m.nombre}">Meta</span>
            <small th:text="${#numbers.formatDecimal((m.actual/m.objetivo)*100,1,'COMMA',0,'POINT')} + '%'">
              0%
            </small>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- ÃšLTIMOS MOVIMIENTOS -->
  <div class="card mb-4">
    <div class="card-header">ğŸ§¾ Ãšltimos movimientos</div>
    <ul class="list-group list-group-flush">
      <li class="list-group-item d-flex justify-content-between"
          th:each="m : ${ultimosMovimientos}"
          th:classappend="${m.tipo=='ingreso'} ? 'text-success' : 'text-danger'">
        <span>
          <strong th:text="${m.tipo=='ingreso'} ? 'Ingreso' : 'Gasto'">Tipo</strong> â€“
          <span th:text="${m.categoria}">CategorÃ­a</span>
        </span>
        <span th:text="${#numbers.formatDecimal(m.cantidad,1,'COMMA',2,'POINT')} + ' â‚¬'">
          0,00 â‚¬
        </span>
      </li>
      <li th:if="${#lists.isEmpty(ultimosMovimientos)}"
          class="list-group-item text-center text-muted">
        No hay movimientos recientes.
      </li>
    </ul>
  </div>

  <!-- GRÃFICAS -->
  <div class="row">
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header">ğŸ“Š Ingresos vs Gastos</div>
        <div class="card-body">
          <canvas id="ingresosGastosChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mb-4">
        <div class="card-header">ğŸ“ Gastos por CategorÃ­a</div>
        <div class="card-body">
          <canvas id="categoriasChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="text-center mt-4 mb-3 text-muted">
  <small>MiFinanzas Â© 2025</small>
</footer>

<script th:inline="javascript">
  const ing = [[${ingresosTotales}]];
  const gas = [[${gastosTotales}]];
  const cats = [[${categorias.values()}]];
  const labels = [[${categorias.keySet()}]];

  new Chart(document.getElementById('ingresosGastosChart'), {
    type: 'bar',
    data: {
      labels: ['Ingresos','Gastos'],
      datasets:[{ label:'Totales (â‚¬)', data:[ing,gas] }]
    }
  });

  new Chart(document.getElementById('categoriasChart'), {
    type:'pie',
    data:{ labels:labels, datasets:[{ data:cats }] }
  });
</script>
</body>
</html>
